# 14. LoDを設定しよう！

## 概要

Levels of Details enable artists to create effects which make effecient
use of system resources and screen space depending on distance to 
the camera. 

詳細レベルにより、アーティストは、距離に応じてシステムリソースとスクリーンスペースを効率的に使用するエフェクトを作成することができます。
カメラとの距離に応じて、システムリソースとスクリーンスペースを効率的に使用するエフェクトを 
エフェクトを作成できます。

```eval_rst
.. image:: ../../img/Reference/lods_Effect.png
   :align: center
```

In this article we will examine sample file `Aura01.efkefc`.
<a href = "../../Sample/14_Sample.zip">You can download it here</a>


```eval_rst
.. image:: ../../img/Reference/lods_NodeList.png
   :align: center
```

In the given effect we can see a node called `Particle`. 
It generates small particles which fly from the base of the tornado to the top.
When camera is close to the effect these particles are visible and add nice
details to the effect. 

このエフェクトでは、`Particle`というノードが見えます。
これは小さな粒子を生成し、竜巻の底部から頂上に向かって飛びます。
カメラがエフェクトに近づくと、これらのパーティクルが見え、エフェクトに素晴らしいディテールを加えます。
の詳細が表示されます。

```eval_rst
.. image:: ../../img/Reference/lods_ParticleInViewer.png
   :align: center
```

However, when camera is far you almost cannot see them because they're quite small, 
but they still need to be calculated and processed each frame of the simulation.
This is a great case of Levels of Details, since it allows to simplify effects
based on the distance. So that effect node can be hidden or shutdown completely when
effect is far from the viewer.

しかし、カメラが遠くにある場合は、かなり小さいので、ほとんど見えません。
しかし、それでもシミュレーションの各フレームで計算し、処理する必要があります。
これは、距離に応じて効果を簡略化することができるため、「詳細レベル」の優れた事例と言えます。
を簡略化することができるからです。そのため、エフェクトノードが視聴者から遠い場合は、非表示にしたり、完全にシャットダウンすることができます。
を非表示にしたり、完全にシャットダウンすることができます。

## Levels Setup

Let's get started with configuring levels we're going to use. Navigate to `Menu > Levels of Details`. 

```eval_rst
.. image:: ../../img/Reference/lods_Panel.png
   :align: center
```

In this panel you specify enabled levels of details and distances from which each
level is enabled. Level 0 is the base level which always starts from distance 0 and is
used when there is no other level which can be selected. You can use up to 4 levels in one effect.

Let's enable Level 1. By default it will have minimum distance set 16, which is 
fine for our case. You can freely set minimum distances of levels to any value which
is not smaller than previous level and not greater than next level.

このパネルでは、有効な詳細レベルと、各レベルを有効にする距離を指定します。
を指定します。レベル0は基本レベルで、常に距離0から始まり、他のレベルが選択できない場合に使用されます。
選択できる他のレベルがない場合に使用されます。1つのエフェクトで最大4つのレベルを使用することができます。

Level 1 を有効にしてみましょう。デフォルトでは、最小距離が16に設定されています。
で問題ありません。レベルの最小距離は自由に設定することができます。
を自由に設定できます。

```eval_rst
.. image:: ../../img/Reference/lods_Panel2.png
   :align: center
```

Now you can try to change camera position using mouse wheel in the Editor 
and you will see that `Current LOD` in lower right corner of the player changes 
to `1` when distance to the effect is greater than 16. 

次に、エディタ上でマウスホイールを使ってカメラの位置を変えてみてください。
プレイヤー右下の `Current LOD` が変化しているのがわかると思います。
が `1` に変わるのがわかります。


## Configuring Particle Node


```eval_rst
.. image:: ../../img/Reference/lods_NodeTreeSelectors.png
   :align: center
```

As you might have noticed, after you've enabled second level each colored button
in the node hierarchy now shows two lines, one for each level. It displays levels
on which each effect node is enabled. By clicking this button
you can change selected levels for each node

Let's click on this button near our `Particle` node.

お気づきのように、セカンドレベルを有効にした後、ノード階層の各色ボタン
は、各レベルごとに2行で表示されます。これは、各エフェクトノードが有効なレベル
が表示され、各エフェクトノードが有効であることを示します。このボタンをクリックすると
をクリックすると、各ノードで選択されているレベルを変更できます。

Particle`ノードの近くでこのボタンをクリックしてみましょう。

```eval_rst
.. image:: ../../img/Reference/lods_NodeConfiguration.png
   :align: center
```

Here you can select levels on which this node is enabled and behaves as usual.
By default each node is enabled on all levels, but we want to disable `Particle` node
on level 1, so let's uncheck that level.

Below levels selection you can change the behaviour of the node which takes
effect when current LOD is not selected. There are three available types of behaviours:

 - Hide Particles - particles continue to spawn and update but they're no longer submitted for rendering.
This reduces usage of the GPU but still consumes CPU resources since update is performed.
 - Stop New Particles Spawn - already spawned particles will continue to update and render but new particles wont be spawned.
This allows  smooth transition between levels since particles wont be abruptly hidden and will be visible until their end of life.
 - Stop New Particles Spawn and Hide Existing - combines two of the previous behaviours. New particles wont be spawned 
and already spawned particle will be hidden. It must be noted that spawned particles will continue to update until their death.

By default `Hide Particles` is selected. 
Let's choose `Stop New Particles Spawn and Hide Existing` since it's suitable in our case. 

ここでは、このノードを有効にし、通常通り動作させるレベルを選択することができます。
デフォルトでは、各ノードはすべてのレベルで有効になっていますが、レベル1では `Particle` ノードを無効にしたいので、そのレベルのチェックを外します。
を無効にしたいので、そのレベルのチェックを外しておきます。

レベル選択の下で、現在のLODが選択されていない時に有効になるノードの挙動を変更することができます。
現在のLODが選択されていない時に適用されます。3種類の動作が用意されています。

 - Hide Particles - パーティクルは引き続きスポーンして更新されますが、レンダリングのために送信されなくなります。
これは GPU の使用を減らしますが、更新が行われるため CPU リソースは消費されます。
 - Stop New Particles Spawn - 既にスポーンされたパーティクルは引き続きアップデートとレンダリングを行いますが、新しいパーティクルはスポーンされません。
これにより、パーティクルが突然隠されることがなく、寿命が尽きるまで表示されるので、レベル間の移行がスムーズになります。
 - Stop New Particles Spawn and Hide Existing - 前の2つの動作を組み合わせたものです。新しいパーティクルは生まれない 
とすでにスポーンされたパーティクルは隠されます。ただし、スポーンされたパーティクルは死ぬまで更新され続けることに注意してください。

デフォルトでは`Hide Particles`が選択されています。
ここでは「Stop New Particles Spawn and Hide Existing`」を選択しましょう。


## Examining Results

We're going to verify our configuration by taking a look at statistics shown in the bottom right corner of the viewer.
 - Current LOD: Level of Detail is currently utilized
 - D: Draw calls of current rendering.
 - V: Vertex count of current rendering.
 - P: Particle count of current rendering.

If we did everything correctly when LOD 0 is active we should see ~115 particles. Then, if you move camera away from effect
up to the distance at which LOD 1 is selected we should observe amount of particles gradually going down to about ~15.

ビューアの右下に表示される統計情報を見て、設定を確認することにします。
 - Current LOD: 現在使用されている詳細度
 - D: 現在のレンダリングの描画コール数
 - V: 現在のレンダリングの頂点数
 - P: 現在のレンダリングのパーティクル数。

LOD 0 がアクティブなときにすべてを正しく実行した場合、約 115 個のパーティクルが表示されるはずです。次に、カメラをエフェクトから遠ざけると
LOD 1 が選択された距離までカメラを遠ざけると、パーティクルの数が徐々に減っていき、約 15 個になることを確認できます。


## Summary

You've learned how to setup levels of details and configure effect nodes to change their behavior
based on currently active level. It's recommended to setup levels of detail at the last step
of your effect production process when you're satisfied with effect look. 

Level of Details are quite versatile and can be setup in various ways, you can even completely replace
effect at the certain distance by making separate root nodes for different level. Effect optimisation 
process can be tricky but sometimes it's what separates you game from barely runnable at 30 fps and stable 60 fps,
so it's a good idea to optimise effects when you can.

詳細レベルを設定する方法と、現在アクティブなレベルに基づいて動作を変更するエフェクトノードの構成について学びました。
を設定する方法について説明しました。詳細レベルの設定は、エフェクト制作の最後のステップで行うことをお勧めします。
を設定することをお勧めします。

詳細レベルは非常に汎用性が高く、様々な方法で設定することができます。
を完全に置き換えることもできます。エフェクトの最適化 
このプロセスは厄介ですが、30fpsでやっと動くゲームと60fpsで安定するゲームを分けるのは、このプロセスである場合もあります。
だから、できる限りエフェクトを最適化するのは良いアイデアです。